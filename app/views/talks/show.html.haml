%p#notice(style='display: none;')= notice

.row(style='padding: 200px' ng-hide='true')
  .large-12.text-center= t('.initializing')

.layout-talk(ng-controller='Livepage' ng-cloak)
  .header-block(style="background-image: url(#{@talk.image.url})")

    .talk-state.text-center
      .span(ng-show='talkIsPrelive()')
        = t('.talk_is_prelive')
        .onHold(ng-show="countdownInSeconds < 0") talk is on hold, waiting to start
      .span(ng-show='talkIsLive()') talk is live
      .span(ng-show='talkIsPostlive()') talk is postlive

    = render partial: '/shared/social_share', locals: { shareable_id: @talk.id, shareable_type: 'talk' }

    .generic-action-bar.row.collapse
      .large-12.columns
        %ul.button-group.right
          - if can? :manage, @talk
            -#
              %li= link_to t('.download_messages'),
                "/venues/#{@talk.venue.id}/talks/#{@talk.id}.text", class: 'button-standard'
            - if !@talk.live?
              %li= link_to t('.edit_talk'), [:edit, @venue, @talk], class: 'button-standard'

            / %li= link_to t('.delete_talk'), [@venue, @talk], class: 'button tiny',
            /   method: :delete, data: { confirm: t('.confirm_delete',
            /   default: 'Are you sure?' ) }

            %li(ng-show='showEndTalk()')
              %button.button.tiny(ng-click='endTalk()')
                = t('.end_talk')

    %section.talk-title-box.row.collapse.text-center
      .large-12.columns
        .type-name= t('.talk')
        .talk-venue-title
          = link_to @talk.venue.title, @talk.venue
        -#.talk-host-name
        -#  = @talk.user.name
        %h2.talk-title
          = @talk.title
        .talk-teaser
          = @talk.teaser
        -#%h3.talk-tags
        -#  = @talk.tag_list
        .talk-date-time
          = t('.date_start_end', date: l(@talk.starts_at, format: :date_only),
          start_time: l(@talk.starts_at, format: :time_only),
          end_time: l(@talk.ends_at, format: :time_only))

    .talk-countdown.row(ng-show='talkIsPrelive()')
      .medium-12.columns.text-center
        .cd-text
          = raw t('.countdown_text')
        .cd-watch
          {{ countdown }}
        .cd-minutes
          = t('.minutes')

    .talk-timeline-box.row.collapse
      .medium-12.columns.text-center
        -# TODO: better integrate player with angularjs
        - if @talk.archived?
          = render partial: 'shared/player', locals: { talk: @talk }
          .embed_player
            %span.label(data-enable-fields=true)= t('.embed_player')
            .share_iframe.hide
              %textarea
                <iframe width="560" height="315" src="//#{request.host}/embed_talk?id=#{@talk.id}" frameborder="0" allowfullscreen></iframe>

        - else
          %div(ng-show='talkIsArchived()')= t('.please_reload_this_page')
        .talk-live-timeline(ng-show='talkIsLive()')
          .talk-timeline
            .talk-timeline-progress(style='width: {{talkProgress}}%')
          .talk-state-info
            .talk-state-bullet
            = t('.state_text')
            - if @talk.record?
              %span.record-text= t('.record_text')
            .talk-timecounter
              %span.right-text-space= t('.ends_in')
              {{ countdown }} MIN

    .talk-talkers-box.row
      .large-12.columns.text-center
        .avatar.avatar-host
          .avatar-box
            = render partial: "shared/avatar_image", locals: {user: @talk.venue.user, img_size: 62}
            .avatar-name.text-center
              {{ config.host }}
        .avatar(ng-repeat="guest in guests()")
          .avatar-box
            = render partial: "shared/avatar_image", locals: {user: 'guest', img_size: 62}
            .avatar-name.text-center
              {{ guest.name }}
          .host-actions(ng-show='showHostActions()')
            .guest-demote-link(ng-click="demote(guest.id)")
              = t('.demote')
      .mute-stream-box(ng-show='talkIsLive()')
        .mute-title= 'Talk:'
        .mute-stream
          %span(ng-click='setVolume(0)')= t('.mute_streams')
        .unmute-stream
          %span(ng-click='setVolume(1)')= t('.unmute_streams')

    .talk-visitors-action-box.row.collapse-large-only(ng-show="userIsAListener()")
      .large-12.columns
        .participate-button-box
          - url = [ @talk.venue, :participations ]
          = link_to t('.participate'), url, method: 'post', class: 'button-vr button-full-size'

    .talk-host-and-participants-action-box.row
      .large-12.columns.text-center
        .talkers-action-box
          .mic-sign-box
            %span.icon-octa-full
            %span.icon-octagon
            %span.icon-mic
          .button-box
            .button-reqmic(ng-show='flags.reqmic'
                          ng-click='requestMic()')= t('.request_mic')
            .button-accept(ng-show='flags.acceptOrDecline'
                          ng-click='acceptPromotion()')= t('.accept_promotion')
            .button-decline(ng-show='flags.acceptOrDecline'
                          ng-click='declinePromotion()')= t('.decline_promotion')
            #onair(ng-show='flags.onair')= t('.you_are_on_air')

          .tmp-mute-box.text-left
            %span.button-mute(ng-show='flags.onair'
                          ng-click='mute()')= t('.mute_mic')
            %span.button-unmute(ng-show='flags.onair'
                          ng-click='unmute()')= t('.unmute_mic')

        .chat-flash-box
          .chat-input-box.row(ng-hide="userIsAListener()")
            .large-12.columns
              .input-box
                %input(ng-model='message.content' ng-keyup='messageKeyup($event)'){:placeholder => t('.chat_placeholder')}
                %span.icon-bubble-multi

          -# FIXME quick and dirty: do not show audio settings
          - if @talk.state=~/^(pre|)live$/
            .button-audio-settings(data-show-audio-settings=".flash-box")
              %span.icon-mic
              = t(".audio_settings")

          -# FIXME quick and dirty: do not show audio settings
          .flash-box.row{ class: @talk.state=~/^(pre|)live$/ ? 'flash-box-open' : '' }
            .large-12.columns.text-left
              #flashContent
              .manual-box
                .flash-manual-title
                  = t('.flash_manual_title')
                %p= raw t('.audio_settings_flash_manual', delimiter: '<br />')
                %button.button-vr
                  = t('.lets_go')
                = link_to 'http://blog.voicerepublic.com/audio-faq/', target: 'blank' do
                  %p.flash-content
                    = raw t('.audio_settings_help_text')

    .download.row(ng-show='talkIsArchived()')
      .large-12.columns.text-center
        %ul.button-group
          %li(ng-repeat='(ext, link) in mediaLinks')
            %a.button(href='{{link}}') {{ext}}

    .row.collapse-large-only
      .large-12.columns
        %dl.tabs.vr-tabs(data-tab="true")
          %dd.active.text-center
            %a(href="#talk-tab-description")
              %span.icon-description
              = t('.description')
          - unless @talk.venue.opts.suppress_chat
            %dd.text-center
              %a(href="#talk-tab-discussion")
                %span.icon-bubble-multi
                = t('.discussion')
          %dd.text-center
            %a(href="#talk-tab-participants")
              %span.icon-people
              = t('.participants')
              %span(ng-show='expectingPromotion().length')
                ({{ expectingPromotion().length }} #{t('.miqrec')})
              %span(ng-show='acceptingPromotion().length')
                ({{ acceptingPromotion().length }} #{t('.awaiting')})

  .talk-tabs-content-block
    .tabs-content
      #talk-tab-description.content.active
        .row
          .large-12.columns
            = @talk.try(:description).try(:html_safe)

      - unless @talk.venue.opts.suppress_chat
        #talk-tab-discussion.content
          .chat-message(ng-repeat='message in discussion')
            .row
              .large-12.columns
                .message-name
                  {{ message.name }}
                .message-content
                  {{ message.content }}
                .message-time
                  17:18:42

      #talk-tab-participants.content
        .row.participants-box
          .large-12.columns
            .expecting_promotion(ng-show='expectingPromotion().length')
              %h3= t('.microphone_requests')
              %ul.medium-block-grid-6.small-block-grid-3
                %li.avatar.text-center(ng-repeat="parti in expectingPromotion()")
                  .avatar-box
                    = render partial: "shared/avatar_image", locals: {user: 'parti', img_size: 52}
                    .avatar-name.text-center {{ parti.name }}
                  .host-actions(ng-show='showHostActions()')
                    .guest-promote-link.text-center(ng-click="promote(parti.id)")
                      = t('.promote')
            .accepting_promotion(ng-show='acceptingPromotion().length')
              %h3= t('.awaiting_to_speak')
              %ul.medium-block-grid-6.small-block-grid-3
                %li.avatar.text-center(ng-repeat="parti in acceptingPromotion()")
                  .avatar-box
                    = render partial: "shared/avatar_image", locals: {user: 'parti', img_size: 52}
                    .avatar-name.text-center {{ parti.name }}
            .participating(ng-show='participants().length')
              %h3= t('.participating')
              %ul.medium-block-grid-6.small-block-grid-3
                %li.avatar.text-center(ng-repeat="parti in participants()")
                  .avatar-box
                    = render partial: "shared/avatar_image", locals: {user: 'parti', img_size: 52}
                    .avatar-name.text-center {{ parti.name }}
                  .host-actions(ng-show='showHostActions()')
                    .guest-promote-link.text-center(ng-click="promote(parti.id)")
                      = t('.promote')
            .listening(ng-show="listeners().length")
              %h3
                {{ listeners().length }}
                = t('.just_listening_in')

.scripts
  = javascript_include_tag 'livepage'
  = render 'config'
