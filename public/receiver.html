<!DOCTYPE html>
<html>
  <head>
    <title>Receiver</title>
    <style type="text/css">
    </style>
    <script src='//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>
    <script src='//kluuu-staging.panter.ch:9293/faye/client.js'></script>
    <script type="text/javascript" src="/swfobject.js"></script>
    <script>
      var flashvars = {};
      var params = {};
      var attributes = { id: "Blackbox", name: "Blackbox" };
      swfobject.embedSWF("/flash/Blackbox.swf", "flashcontent", "550", "400", "10.3.181.22", null, flashvars, params, attributes);

      var flash = null;

      var flashLog = function(msg) {
        log('flashLog: '+msg);
      }

      var log = function(msg) {
        if(console!=undefined) console.log(msg);
        $('#log').prepend('<p>'+msg+'</p>');
      }

      var subscriptions = [];

      var subscribeStream = function(uuid) {
        log('subscribe '+uuid);
        flash.subscribe(uuid);
        // keep track of what streams already subscribed to
        subscriptions.push(uuid);
      }

      var client = new Faye.Client('http://kluuu-staging.panter.ch:9293/faye');

      // subscribe to streams when they are announced
      client.subscribe('/announce', function(msg) {
        log('announce '+msg.uuid);
        if ($.inArray(msg.uuid, subscriptions) != -1) return;
        if (msg.uuid == 'undefined') return; // remove me
        subscribeStream(msg.uuid);
      });

      $(function() {
        // send feeback
        $('#send').click(function() {
          var content = $('#content').val();
          client.publish('/feedback', content);
          $('#dialog').prepend('<p>'+content+'</p>');
          $('#content').val('');
        });
      });

      var flashInitialized = function() {
        log('flashInitialized');
        var isInternetExplorer = navigator.appName.indexOf("Microsoft") != -1;
        flash = isInternetExplorer ? document.all.Blackbox : document.Blackbox;
        // register so streams get reannounced
        client.publish('/register', {});
      }
    </script>
  </head>

  <body>
    <h1>Receiver</h1>
    <p>Please describe your listening experience.</p>
    <textarea id="content" style='width: 400px; height: 100px'></textarea>
    <br/>
    <button id="send">send</button>
    <div id='dialog'>
    </div>
    <div id="log">
    </div>
    <div id="flashcontent">
      <p>Flash not installed</p>
    </div>
  </body>
</html>
