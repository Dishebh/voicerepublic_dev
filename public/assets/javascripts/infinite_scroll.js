// Generated by CoffeeScript 1.9.3
(function() {
  var attribute, initialize;

  attribute = 'data-infinite-scroll';

  initialize = function(node, value) {
    var loading, pager, ref, spy, target;
    ref = value.split('|'), spy = ref[0], target = ref[1], pager = ref[2];
    loading = false;
    return $(window).scroll(function() {
      var bottom, page, pos, query, top, url;
      if (loading) {
        return;
      }
      if (!$(spy).size()) {
        return;
      }
      top = $(window).scrollTop();
      bottom = top + $(window).height();
      pos = $(spy).offset().top;
      if (pos <= bottom && pos >= top) {
        loading = true;
        page = parseInt($(pager).val());
        page = page + 1;
        $(pager).val(page);
        query = $(node).serialize() + '&page=' + page;
        url = window.location.pathname + '?' + query;
        NProgress.start();
        return $.ajax(url, {
          success: function(data) {
            $(target).append(data);
            NProgress.done();
            loading = false;
            if (!data.trim()) {
              return $(spy).remove();
            }
          }
        });
      }
    });
  };

  $("*[" + attribute + "]").each(function(index, element) {
    var value;
    value = $(element).attr(attribute);
    return initialize(element, value);
  });

}).call(this);
