#!/bin/bash

if [ -f /sys/hypervisor/uuid ] && [ `head -c 3 /sys/hypervisor/uuid` == ec2 ]; then
  PUBLIC_IP=$(curl http://instance-data.ec2.internal/latest/meta-data/public-ipv4)
else
  PUBLIC_IP=`hostname -I | cut -d ' ' -f 1`
fi

function realpath { echo $(cd $(dirname $1); pwd)/$(basename $1); }

ENV_LIST=`realpath env.list`

cat >$ENV_LIST <<EOF
<%= env_list %>
PUBLIC_IP=$PUBLIC_IP
EOF

docker run \
       --detach=true \
       --name=icecast \
       --env-file=$ENV_LIST \
       --expose=8000 \
       --publish=<%= port %>:8000 \
       --restart=unless-stopped \
       branch14/icecast2

# --- move into image

command -v curl >/dev/null 2>&1 || \
  apt-get -y install curl



# --- move into docker

# CALLBACK_URL=<%= icecast_callback_url %>
CLIENT_TOKEN=<%= client_token %>

#if [ -f /sys/hypervisor/uuid ] && [ `head -c 3 /sys/hypervisor/uuid` == ec2 ]; then
#    true
#else
#    sleep 5
#fi

#JSON='{"public_ip_address":"'$PUBLIC_IP'","client_token":"'$CLIENT_TOKEN'"}'
#curl -X POST --data "$JSON" $CALLBACK_URL/complete


# callback to slack -- for debugging only
TEXT="Started Icebox on $PUBLIC_IP with client token $CLIENT_TOKEN"
JSON='{"channel":"@phil","text":"'$TEXT'","icon_emoji":":mushroom:","username":"icecast"}'

curl -X POST -H 'Content-type: application/json' --data "$JSON" \
     https://hooks.slack.com/services/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
